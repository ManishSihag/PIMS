name: deploy-api-to-test

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to deploy - PR number'
        required: true
        default: latest
    
jobs:     
    Deploy:
      name: Deploy to OpenShift
      runs-on: ubuntu-latest
      steps:
        - name: Checkout Repository
          uses: actions/checkout@v3 

        - name: Get PR Number
          id: pr
          run: |
            if [[ "${{ inputs.tag }}" == "latest" ]]; then
              PR=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/pulls?state=closed&base=main" | jq -r '.[0].number')
            else
              PR="${{ inputs.tag }}"
            fi
            echo "PR Number: $PR"
            echo "::set-output name=pr_number::$PR"
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
        - name: Login to OpenShift
          uses: redhat-actions/oc-login@v1
          with:
            openshift_server_url: ${{ secrets.OPENSHIFT_SERVER_URL }}
            openshift_token: ${{ secrets.OPENSHIFT_SA_DEV_TOKEN }}
            namespace: ${{ secrets.OPENSHIFT_DEV_NAMESPACE }}

        - name: Deploy DeploymentConfig
          env:
            APPLICATION_NAME: "pims-api"
            DEPLOYMENT_CONFIG: "api-dc-template.yaml"
            IMAGE_REPOSITORY: ${{ secrets.PUBLIC_IMAGE_REPOSITORY }}
            PR_TAG: ${{ steps.pr.outputs.pr_number }}  # PR number as the tag
          run: |
            oc apply -f /home/runner/work/PIMS/PIMS/openshift/templates/api-dc-template.yaml
             
    Health-Check:
      name: Check Deployment Health
      runs-on: ubuntu-latest
      needs: [ Deploy ]
      steps:
        - name: Login to OpenShift
          uses: redhat-actions/oc-login@v1
          env:
            OPENSHIFT_USER: github-actions
            OPENSHIFT_PROJECT: ${{ secrets.OPENSHIFT_DEV_NAMESPACE }}
          with:
            openshift_server_url: ${{ secrets.OPENSHIFT_SERVER_URL }}
            openshift_token: ${{ secrets.OPENSHIFT_SA_DEV_TOKEN }}
            namespace: ${{ secrets.OPENSHIFT_DEV_NAMESPACE }}

        - name: Check Deployment Status
          run: |
            oc rollout status -n ${{ secrets.OPENSHIFT_DEV_NAMESPACE }} dc/pims-api --watch

    Clean-Up:
      name: Clean Up
      runs-on: ubuntu-latest
      needs: [ Health-Check ]
      steps:
        - name: Login to OpenShift
          uses: redhat-actions/oc-login@v1
          env:
            OPENSHIFT_USER: github-actions
            OPENSHIFT_PROJECT: ${{ secrets.OPENSHIFT_DEV_NAMESPACE }}
          with:
            openshift_server_url: ${{ secrets.OPENSHIFT_SERVER_URL }}
            openshift_token: ${{ secrets.OPENSHIFT_SA_DEV_TOKEN }}
            namespace: ${{ secrets.OPENSHIFT_DEV_NAMESPACE }}

        - name: Remove previous objects
          run: |
            oc delete pod -n ${{ secrets.OPENSHIFT_DEV_NAMESPACE }} --field-selector status.phase=Succeeded

        - name: Remove previous replication controllers
          run: |
            oc delete rc -n ${{ secrets.OPENSHIFT_DEV_NAMESPACE }} --field-selector status.replicas=0
